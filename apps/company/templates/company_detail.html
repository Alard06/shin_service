{% extends 'base.html' %}
{% load form_tags %}
{% block content %}
<div class="container mt-4">
    <h1>Настройки компании: {{ company.name }}</h1>
    <a href="{% url 'company_list' %}" class="btn btn-secondary mb-3">Назад к списку компаний</a>

    <!-- Вкладки -->
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="general-info-tab" data-toggle="tab" href="#general-info" role="tab"
               aria-controls="general-info" aria-selected="true">Общая информация</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="settings-tab" data-toggle="tab" href="#settings" role="tab" aria-controls="settings"
               aria-selected="false">Настройки</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="suppliers-tab" data-toggle="tab" href="#suppliers" role="tab"
               aria-controls="suppliers" aria-selected="false">Поставщики</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="add-suppliers-tab" data-toggle="tab" href="#add-suppliers" role="tab"
               aria-controls="add-suppliers" aria-selected="false">Добавить поставщиков</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="unique-tab" data-toggle="tab" href="#unique" role="tab" aria-controls="unique"
               aria-selected="false">Уникализатор</a>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="general-info" role="tabpanel" aria-labelledby="general-info-tab">
            <h2>Общая информация</h2>
            <p>Здесь будет информация о компании.</p>
        </div>
        <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
            <h2>Настройки</h2>
            <p>Здесь будут настройки компании.</p>
        </div>
<div class="tab-pane fade" id="suppliers" role="tabpanel" aria-labelledby="suppliers-tab">
    <h2>Поставщики</h2>
    <table class="table table-bordered">
        <thead class="thead-dark">
            <tr>
                <th>Имя</th>
                <th>Артикул</th>
                <th>Приоритет</th>
                <th>Визуальный приоритет</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for company_supplier in suppliers %}
            <tr class="{% if company_supplier.visual_priority == 1 %}priority-1{% elif company_supplier.visual_priority == 2 %}priority-2{% elif company_supplier.visual_priority == 3 %}priority-3{% endif %}" style="cursor:pointer;">
                <td>{{ company_supplier.supplier.name }}</td>
                <td>{{ company_supplier.article_number }}</td>
                <td>{{ company_supplier.priority }}</td>
                <td>
                    {% if company_supplier.visual_priority == 1 %}
                        <span class="badge badge-success">Зеленый</span>
                    {% elif company_supplier.visual_priority == 2 %}
                        <span class="badge badge-warning">Желтый</span>
                    {% elif company_supplier.visual_priority == 3 %}
                        <span class="badge badge-danger">Красный</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{% url 'edit_company_supplier' company_supplier.id %}" class="btn btn-warning btn-sm">Редактировать</a>
                    <form action="{% url 'delete_supplier' company_supplier.id %}" method="POST" style="display:inline;" onsubmit="return confirm('Вы уверены, что хотите удалить этого поставщика у компании?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-sm">Удалить</button>
                    </form>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="text-center">Нет поставщиков.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


<div class="tab-pane fade" id="add-suppliers" role="tabpanel" aria-labelledby="add-suppliers-tab">
    <h2>Добавить поставщиков</h2>
    <form method="post" action="{% url 'add_suppliers_to_company' company.id %}">
        {% csrf_token %}
        <input type="hidden" name="suppliers" id="selected-suppliers" value="">
        <table class="table">
            <thead>
                <tr>
                    <th>Поставщик</th>
                </tr>
            </thead>
            <tbody>
                {% for supplier in available_suppliers %}
                <tr data-supplier-id="{{ supplier.id }}" class="supplier-row" style="cursor: pointer;">
                    <td>{{ supplier.name }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="1" class="text-center">Нет доступных поставщиков для добавления.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="submit" class="btn btn-primary">Добавить поставщиков</button>
    </form>
</div>

    <div class="tab-pane fade" id="unique" role="tabpanel" aria-labelledby="unique-tab">
        <h2>Уникализатор</h2>
        <p>Здесь будет информация о уникализаторе.</p>
    </div>
</div>
</div>

<script>
    document.querySelectorAll('.supplier-row').forEach(row => {
        row.addEventListener('click', function() {
            const supplierId = this.getAttribute('data-supplier-id');
            const selectedSuppliersInput = document.getElementById('selected-suppliers');
            let selectedSuppliers = selectedSuppliersInput.value ? selectedSuppliersInput.value.split(',') : [];

            // Проверяем, выбран ли уже поставщик
            if (selectedSuppliers.includes(supplierId)) {
                // Удаляем поставщика из списка, если он уже выбран
                selectedSuppliers = selectedSuppliers.filter(id => id !== supplierId);
                this.classList.remove('table-active'); // Убираем выделение
            } else {
                // Добавляем поставщика в список
                selectedSuppliers.push(supplierId);
                this.classList.add('table-active'); // Добавляем выделение
            }

            // Обновляем скрытое поле с выбранными поставщиками
            selectedSuppliersInput.value = selectedSuppliers.join(',');
        });
    });
</script>

{% endblock %}
